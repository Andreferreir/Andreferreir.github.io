<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Gestão de Briefing - Cloud</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #eef2f3; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 1000px; }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        label { font-size: 12px; color: #666; margin-bottom: -10px; margin-left: 5px; }
        button { background: #007bff; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
        th { background: #f8f9fa; color: #333; }
        .btn-delete { background: #ff4757; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        #status { text-align: center; margin-bottom: 15px; font-weight: bold; color: #2c3e50; }
        .badge { background: #e3f2fd; color: #0d47a1; padding: 3px 8px; border-radius: 10px; font-weight: bold; text-transform: capitalize; }
    </style>
</head>
<body>

<div class="card">
    <h2>Registo de Briefing (Coleção t)</h2>
    <div id="status">A verificar ligação...</div>

    <div class="grid-inputs">
        <div style="display:flex; flex-direction:column; gap:5px;">
            <input type="datetime-local" id="c_date">
        </div>
        <div style="display:flex; flex-direction:column; gap:5px;">
            <input type="email" id="c_email" placeholder="email@exemplo.com">
        </div>
        <input type="text" id="c_kitid" placeholder="Kit ID">
        <input type="text" id="c_user" placeholder="Nome do Piloto">
        <button onclick="adicionar()" style="grid-column: span 2;">Regist</button>
    </div>

    <table id="tabelaDados">
        <thead>
            <tr>
                <th>Date/Time</th>
                <th>Email</th>
                <th>Kit ID</th>
                <th>Pilot</th>
                <th>Briefing by</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    // 1. CONFIGURAÇÃO (COLE AS SUAS CHAVES AQUI)
    const firebaseConfig = {
         apiKey: "AIzaSyCE-56sZnfFY-0auEmnD1i3PMFHrT936Yc",
  authDomain: "ipads-77c1b.firebaseapp.com",
  projectId: "ipads-77c1b",
  storageBucket: "ipads-77c1b.firebasestorage.app",
  messagingSenderId: "332708198774",
  appId: "1:332708198774:web:994832fcf1e7a4eec96257",
  measurementId: "G-MGL5RHFZ1N"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const statusDiv = document.getElementById("status");

    // FUNÇÃO PARA PREENCHER O INPUT DATETIME-LOCAL COM O AGORA
    function atualizarDataInput() {
        const agora = new Date();
        // Ajuste para o fuso horário local (formato YYYY-MM-DDTHH:mm)
        agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
        document.getElementById("c_date").value = agora.toISOString().slice(0, 16);
    }

    // Executa ao abrir
    window.onload = atualizarDataInput;

    // 2. LER DADOS EM TEMPO REAL
    db.collection("t").orderBy("timestamp_sistema", "desc").onSnapshot((snapshot) => {
        const tbody = document.querySelector("#tabelaDados tbody");
        tbody.innerHTML = "";
        
        snapshot.forEach((doc) => {
            const item = doc.data();
            const id = doc.id;
            
            // Formatar a data para exibição mais bonita na tabela
            const dataExibicao = item.date ? item.date.replace('T', ' ') : '-';

            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${dataExibicao}</td>
                <td>${item.email || '-'}</td>
                <td>${item['kit id'] || '-'}</td>
                <td>${item.user || '-'}</td>
                <td><span class="badge">${item.briefing_by || '-'}</span></td>
                <td><button class="btn-delete" onclick="remover('${id}')">Apagar</button></td>
            `;
        });
        statusDiv.innerText = "Sincronizado com Firebase";
    }, (error) => {
        statusDiv.innerText = "Erro de Permissão! Verifique as Rules.";
        statusDiv.style.color = "red";
    });

    // 3. ADICIONAR COM POPUP DE UTILIZADOR
    function adicionar() {
        const authUser = prompt("Quem está a realizar este briefing? (rodrigo/tiago)");
        
        if (!authUser) return; // Se cancelar o prompt
        const userLower = authUser.toLowerCase().trim();

        if (userLower !== "rodrigo" && userLower !== "tiago") {
            alert("Acesso Negado: '" + authUser + "' não tem permissão para adicionar.");
            return;
        }

        const v_date = document.getElementById("c_date").value;
        const v_email = document.getElementById("c_email").value;
        const v_kitid = document.getElementById("c_kitid").value;
        const v_user = document.getElementById("c_user").value;

        if(!v_date || !v_email || !v_user) return alert("Por favor, preencha todos os campos obrigatórios.");

        statusDiv.innerText = "A guardar na nuvem...";

        db.collection("t").add({
            date: v_date,
            email: v_email,
            "kit id": v_kitid,
            user: v_user,
            briefing_by: userLower,
            timestamp_sistema: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            statusDiv.innerText = "Adicionado com sucesso por " + userLower;
            // Limpa campos exceto a data (que reiniciamos para o momento atual)
            document.getElementById("c_email").value = "";
            document.getElementById("c_kitid").value = "";
            document.getElementById("c_user").value = "";
            atualizarDataInput();
        })
        .catch(err => alert("Erro ao gravar: " + err.message));
    }

    // 4. REMOVER COM POPUP DE UTILIZADOR
    function remover(id) {
        const authUser = prompt("Confirme o seu nome de utilizador para apagar:");
        
        if (!authUser) return;
        const userLower = authUser.toLowerCase().trim();

        if (userLower !== "rodrigo" && userLower !== "tiago") {
            alert("Acesso Negado: Não tem permissão para eliminar.");
            return;
        }

        if(confirm("Deseja mesmo eliminar este registo permanentemente?")) {
            db.collection("t").doc(id).delete()
            .then(() => statusDiv.innerText = "Registo removido.");
        }
    }
</script>

</body>
</html>


