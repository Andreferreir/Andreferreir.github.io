<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Gestão de Briefing - Cloud</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #eef2f3; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 900px; }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        button { background: #007bff; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 14px; }
        th { background: #f8f9fa; color: #333; }
        .btn-delete { background: #ff4757; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        #status { text-align: center; margin-bottom: 15px; font-weight: bold; color: #2c3e50; }
        .badge { background: #e3f2fd; color: #0d47a1; padding: 4px 10px; border-radius: 12px; font-weight: bold; text-transform: capitalize; font-size: 12px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Registo de Briefing (Coleção t)</h2>
    <div id="status">A verificar ligação...</div>

    <div class="grid-inputs">
        <input type="email" id="c_email" placeholder="Email do Piloto">
        <input type="text" id="c_kitid" placeholder="Kit ID">
        <input type="text" id="c_user" placeholder="Nome do Piloto" style="grid-column: span 2;">
        <button onclick="adicionar()" style="grid-column: span 2;">Efetuar Registo</button>
    </div>

    <table id="tabelaDados">
        <thead>
            <tr>
                <th>Email</th>
                <th>Kit ID</th>
                <th>Piloto</th>
                <th>Briefing por</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    // 1. CONFIGURAÇÃO (COLE AS SUAS CHAVES AQUI)
    const firebaseConfig = {
        apiKey: "AIzaSyCE-56sZnfFY-0auEmnD1i3PMFHrT936Yc",
  authDomain: "ipads-77c1b.firebaseapp.com",
  projectId: "ipads-77c1b",
  storageBucket: "ipads-77c1b.firebasestorage.app",
  messagingSenderId: "332708198774",
  appId: "1:332708198774:web:994832fcf1e7a4eec96257",
  measurementId: "G-MGL5RHFZ1N"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const statusDiv = document.getElementById("status");

    // 2. LER DADOS EM TEMPO REAL (Ordenados pela data de inserção)
    db.collection("t").orderBy("date", "desc").onSnapshot((snapshot) => {
        const tbody = document.querySelector("#tabelaDados tbody");
        tbody.innerHTML = "";
        
        snapshot.forEach((doc) => {
            const item = doc.data();
            const id = doc.id;
            
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${item.email || '-'}</td>
                <td>${item['kit id'] || '-'}</td>
                <td>${item.user || '-'}</td>
                <td><span class="badge">${item.briefing_by || '-'}</span></td>
                <td><button class="btn-delete" onclick="remover('${id}')">Apagar</button></td>
            `;
        });
        statusDiv.innerText = "Sincronizado com Firebase";
    }, (error) => {
        console.log(error);
        statusDiv.innerText = "Erro ao carregar dados.";
    });

    // 3. ADICIONAR COM VALIDAÇÃO E DATA AUTOMÁTICA NO CAMPO "date"
    function adicionar() {
        const authUser = prompt("Quem está a realizar este briefing? (rodrigo/tiago)");
        if (!authUser) return;
        const userLower = authUser.toLowerCase().trim();

        if (userLower !== "rodrigo" && userLower !== "tiago") {
            alert("Acesso Negado: Utilizador não autorizado.");
            return;
        }

        const v_email = document.getElementById("c_email").value;
        const v_kitid = document.getElementById("c_kitid").value;
        const v_user = document.getElementById("c_user").value;

        if(!v_email || !v_user) return alert("Preencha o Email e o Nome do Piloto.");

        statusDiv.innerText = "A guardar...";

        // Gravação na Firebase
        db.collection("t").add({
            email: v_email,
            "kit id": v_kitid,
            user: v_user,
            briefing_by: userLower,
            // AQUI ESTÁ A DATA: O Firebase gera automaticamente o timestamp
            date: firebase.firestore.FieldValue.serverTimestamp() 
        })
        .then(() => {
            statusDiv.innerText = "Adicionado por " + userLower;
            document.getElementById("c_email").value = "";
            document.getElementById("c_kitid").value = "";
            document.getElementById("c_user").value = "";
        })
        .catch(err => alert("Erro: " + err.message));
    }

    // 4. REMOVER COM VALIDAÇÃO
    function remover(id) {
        const authUser = prompt("Confirme o seu nome para apagar:");
        if (!authUser) return;
        const userLower = authUser.toLowerCase().trim();

        if (userLower !== "rodrigo" && userLower !== "tiago") {
            alert("Não autorizado.");
            return;
        }

        if(confirm("Eliminar registo permanentemente?")) {
            db.collection("t").doc(id).delete();
        }
    }
</script>

</body>
</html>
