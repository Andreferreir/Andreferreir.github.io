<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Gestão de Briefing</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f3; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 1000px; }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #007bff; color: white; border: none; padding: 12px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
        th { background: #f8f9fa; }
        .btn-delete { background: #ff4757; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        #status { text-align: center; margin-bottom: 15px; font-size: 14px; color: #666; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>Registo de Briefing</h2>
    <div id="status">A ligar à nuvem...</div>

    <div class="grid-inputs">
        <input type="text" id="c_date" placeholder="Data e Hora">
        <input type="text" id="c_email" placeholder="Email do Piloto">
        <input type="text" id="c_kitid" placeholder="Kit ID">
        <input type="text" id="c_user" placeholder="Nome do Piloto">
        <button onclick="adicionar()" style="grid-column: span 2;">Adicionar Registo</button>
    </div>

    <table id="tabelaDados">
        <thead>
            <tr>
                <th>Data/Hora</th>
                <th>Email</th>
                <th>Kit ID</th>
                <th>Piloto</th>
                <th>Briefing por</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script>
    // 1. CONFIGURAÇÃO FIREBASE (Substitui pelos teus dados)
    const firebaseConfig = {
        apiKey: "AIzaSyCE-56sZnfFY-0auEmnD1i3PMFHrT936Yc",
  authDomain: "ipads-77c1b.firebaseapp.com",
  projectId: "ipads-77c1b",
  storageBucket: "ipads-77c1b.firebasestorage.app",
  messagingSenderId: "332708198774",
  appId: "1:332708198774:web:994832fcf1e7a4eec96257",
  measurementId: "G-MGL5RHFZ1N"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const statusDiv = document.getElementById("status");

    // FUNÇÃO PARA GERAR DATA ATUAL NO INPUT
    function configurarDataAtual() {
        const agora = new Date();
        const dataFormatada = agora.toLocaleDateString('pt-PT') + ' ' + 
                            agora.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
        document.getElementById("c_date").value = dataFormatada;
    }

    // EXECUTAR AO CARREGAR A PÁGINA
    window.onload = () => {
        configurarDataAtual();
    };

    // 2. LER DADOS
    db.collection("t").orderBy("timestamp_sistema", "desc").onSnapshot((snapshot) => {
        const tbody = document.querySelector("#tabelaDados tbody");
        tbody.innerHTML = "";
        snapshot.forEach((doc) => {
            const item = doc.data();
            const id = doc.id;
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${item.date || '-'}</td>
                <td>${item.email || '-'}</td>
                <td>${item['kit id'] || '-'}</td>
                <td>${item.user || '-'}</td>
                <td><strong>${item.briefing_by || '-'}</strong></td>
                <td><button class="btn-delete" onclick="remover('${id}')">Apagar</button></td>
            `;
        });
        statusDiv.innerText = "Sincronizado com a Nuvem";
    });

    // 3. ADICIONAR COM VALIDAÇÃO
    function adicionar() {
        const userResponsavel = prompt("Quem está a fazer o briefing? (rodrigo/tiago)").toLowerCase().trim();

        if (userResponsavel !== "rodrigo" && userResponsavel !== "tiago") {
            alert("Acesso Negado: Utilizador não autorizado.");
            return;
        }

        const v_date = document.getElementById("c_date").value;
        const v_email = document.getElementById("c_email").value;
        const v_kitid = document.getElementById("c_kitid").value;
        const v_user = document.getElementById("c_user").value;

        if(!v_email || !v_user) return alert("Preencha o Email e o Nome do Piloto.");

        statusDiv.innerText = "A guardar...";

        db.collection("t").add({
            date: v_date,
            email: v_email,
            "kit id": v_kitid,
            user: v_user,
            briefing_by: userResponsavel, // NOVO CAMPO
            timestamp_sistema: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
            statusDiv.innerText = "Registo adicionado por " + userResponsavel;
            document.querySelectorAll("input").forEach(i => i.value = "");
            configurarDataAtual(); // Reinicia a data para o próximo
        })
        .catch(err => alert("Erro: " + err.message));
    }

    // 4. REMOVER COM VALIDAÇÃO
    function remover(id) {
        const userResponsavel = prompt("Confirme o seu nome para apagar:").toLowerCase().trim();

        if (userResponsavel !== "rodrigo" && userResponsavel !== "tiago") {
            alert("Não tem permissão para eliminar registos.");
            return;
        }

        if(confirm("Tem a certeza que deseja eliminar este registo permanentemente?")) {
            db.collection("t").doc(id).delete()
            .then(() => statusDiv.innerText = "Registo eliminado.");
        }
    }
</script>

</body>
</html>

